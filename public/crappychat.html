
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Crappy Chat Demo</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>
        .message:first-child { border-top:none; }
        .message { border-top:1px solid gray; }
        .message-same-user { border-top:1px dashed gray; }
        .message-self { background-color: cornsilk; }
        .message span { font-weight:bold; margin-right:8px; color:navy; }
        .message-self span { color:darkgreen; }
    </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark navbar-light bg-light">
    <span class="navbar-brand mb-0 h1">Crappy Chat</span>
</nav>
<div class="container">
    <div class="row">
        <div class="col-12 col-md-8 order-2 order-md-1" style="height:500px">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="card-title">Messages. <span id="loginStatus"></span></h6>
                </div>
                <div class="card-body overflow-auto">
                    <div id="chatMessages"></div>
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input disabled type="text" class="form-control" id="chatInput"
                               placeholder="Type your message here..">
                        <button disabled class="btn btn-warning btn-sm" id="chatInputButton">Send</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4 order-1 order-md-2" style="height:500px">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="card-title">Players. Session Count=<span id="sessionCount">0</span></h6>
                </div>
                <div id="chatPlayers" class="card-body overflow-auto">
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col" style="height:300px">
            <div class="card h-100">
                <div class="card-header">
                    <h5>Audit</h5>
                </div>
                <div class="card-body overflow-auto">
                    <div id="chatAudit"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<script src="/mwi-websocket.js"></script>
<script type="text/javascript">
    "use strict";
    LiveConnection.onConnectionStateChange(function(e) { console.log('Test connection State callback got: ' + e); });
    $(function() {
        console.log(LiveConnection.mwiHost);

        LiveConnection.onConnectionStateChange(function(status) {
            var chatAudit = $('#chatAudit');
            chatAudit.append('<div>[Connection Status]'
                + ' <b>' + status + '</b></div');
            chatAudit.parent().scrollTop(chatAudit.parent()[0].scrollHeight);
        });

        var crappyChat = LiveConnection.join('crappychat');
        crappyChat.send('test');
        var lastPlayer = -1;

        $('#chatInput').keypress(function(event) {
            if (event.which === 13)  {
                if ($(this).val() !== "") crappyChat.send("chat", $(this).val());
                $(this).val("");
                event.preventDefault()
            }
        });
        
        $('#chatInputButton').click(function(event) {
            var input = $('#chatInput');
            crappyChat.send("chat", input.val());
            input.val("");
            event.preventDefault()        
        });

        //Data is expected to be [player, playerName, message]
        crappyChat.on('chat', function(data) {
            if (typeof data !== 'object') throw "Unexpected data in chat message";
            var player = data[0];
            var playerName = data[1];
            var message = data[2];
            var chatOutput = $('#chatMessages');
            var classes = "message";
            if (player === LiveConnection.playerDbref()) classes += " message-self";
            if (player === lastPlayer) classes += " message-same-user";
            lastPlayer = player;
            var safeParse = $('<div></div>');
            safeParse.text(message);
            var nextMessage = $('<div class="' + classes + '"><span>' + playerName + '</span>' + safeParse.text() + '</div>');
            chatOutput.append(nextMessage);
            chatOutput.parent().scrollTop(chatOutput.parent()[0].scrollHeight);
        });
        
        crappyChat.on('sessionCount', function(data){
            var sessionCount = $('#sessionCount');
            sessionCount.text(data);
        });

        crappyChat.on('playerList', function(data){
            var playerList = $('#chatPlayers');
            playerList.empty();
            for (var i= 0, maxi=data.length; i < maxi; i++) {
                playerList.append(data[i] + "<br>");
            }
        });

        crappyChat.on('sessionConnected', function(data) {
            if (LiveConnection.player()) {
                $('#chatInputButton').prop('disabled', false);
                $('#chatInput').prop('disabled', false);
                $('#loginStatus').text("Logged in as " + LiveConnection.playerName());
            } else {
                $('#chatInputButton').prop('disabled', true);
                $('#chatInput').prop('disabled', true);
                $('#loginStatus').text("No login information");
            }
        });

        crappyChat.any(function(message, data, outgoing) {
            var chatAudit = $('#chatAudit');
            chatAudit.append('<div>' + (outgoing ? '[>>]' : '[<<]')
                + ' <b>' + message + '</b> ' + JSON.stringify(data) + '</div');
            chatAudit.parent().scrollTop(chatAudit.parent()[0].scrollHeight);
        });
    });
</script>
</body>
</html>